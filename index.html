async function exportInvoicePDF(filename){
  const el = document.getElementById("invoiceTemplate");
  if(!el) throw new Error("invoiceTemplate missing");

  const parent = el.parentNode;
  const next = el.nextSibling;
  const prevStyle = el.getAttribute("style") || "";

  // ✅ نخلي الفاتورة داخل Stage ظاهر (حتى html2canvas ما يطلع أبيض)
  const stage = document.createElement("div");
  stage.style.cssText = `
    position: fixed; inset: 0;
    background: #fff;
    z-index: 2147483647;
    overflow: auto;
    padding: 16px;
  `;
  document.body.appendChild(stage);
  stage.appendChild(el);

  el.style.display = "block";
  el.style.position = "relative";
  el.style.left = "0";
  el.style.top = "0";
  el.style.background = "#fff";
  el.style.opacity = "0.001";     // يظل مرسوم بس ما يبين
  el.style.pointerEvents = "none";

  // ننتظر رندر + خطوط + صور
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch(_) {} }

  const imgs = [...el.querySelectorAll("img")];
  await Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(res => {
    img.onload = img.onerror = () => res();
  })));

  const scale = (window.innerWidth <= 600) ? 1.1 : 1.5;

  const canvas = await html2canvas(el, {
    scale,
    backgroundColor: "#ffffff",
    useCORS: true,
    allowTaint: true,
    imageTimeout: 15000
  });

  el.style.opacity = "1";

  const pdf = new window.jspdf.jsPDF({ orientation:"p", unit:"pt", format:"a4", compress:true });
  const pageWidth  = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const pxPerPt = canvas.width / pageWidth;
  const pagePxHeight = Math.floor(pageHeight * pxPerPt);

  const pageCanvas = document.createElement("canvas");
  const pageCtx = pageCanvas.getContext("2d");

  let y = 0, pageIndex = 0;
  while (y < canvas.height) {
    const sliceHeight = Math.min(pagePxHeight, canvas.height - y);

    pageCanvas.width = canvas.width;
    pageCanvas.height = sliceHeight;

    pageCtx.fillStyle = "#ffffff";
    pageCtx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);

    pageCtx.drawImage(canvas, 0, y, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);

    const imgData = pageCanvas.toDataURL("image/jpeg", 0.92);
    if (pageIndex > 0) pdf.addPage();

    const imgWidth = pageWidth;
    const imgHeight = (sliceHeight * imgWidth) / pageCanvas.width;
    pdf.addImage(imgData, "JPEG", 0, 0, imgWidth, imgHeight);

    y += sliceHeight;
    pageIndex++;
  }

  // ✅ داخل WebView: pdf.save() مرات يتصرف غلط/ما يفتح صح
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);

  // جرّب فتحه حتى المستخدم يطبعه/يشاركه من عارض الـPDF
  // (بعض WebView ما تحب window.open، فنسوي الاثنين)
  try { window.open(url, "_blank"); } catch(_) {}
  setTimeout(() => { location.href = url; }, 50);

  setTimeout(() => URL.revokeObjectURL(url), 20000);

  // رجّع كلشي مثل ما كان
  stage.remove();
  if (next) parent.insertBefore(el, next); else parent.appendChild(el);
  el.setAttribute("style", prevStyle);
}
